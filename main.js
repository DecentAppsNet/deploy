async function P(t,e){let o=t.length,n=[...t];return new Promise((r,s)=>{function i(c){c().then(()=>{if(--o===0){r();return}if(n&&n.length){let u=n.pop();u&&i(u)}}).catch(u=>s(u))}let a=Math.min(e,t.length);for(let c=0;c<a;++c){let u=n.pop();u&&i(u)}}).catch(r=>{throw r})}function J(t){return/^[0-9a-f]{7}$/i.test(t)}function Q(t){return/^[0-9a-f]{40}$/i.test(t)}function S(t){return J(t)||Q(t)}function b(t){return t.length>7?t.slice(0,7):t}var $=class extends Error{constructor(e){super(e),this.name="ExpectedError"}},p=$;function Z(t){console.error(`::error::${t}`)}function O(t){console.warn(`::warning::${t}`)}function tt(t){console.log(`::notice::${t}`)}function E(t){tt(`\u2705 ${t}`)}function x(t){Z(t),process.exit(1)}function g(t){console.log(`::group::${t}`)}function h(){console.log("::endgroup::")}var m="";function w(t){process.stdout.write(`${t}...`),m=t}function y(){process.stdout.write(`\r${m}... done
`),m=""}function V(){process.stdout.write(`\r${m}... FAILED
`),m=""}function v(t,e=!1){let o=`INPUT_${t.replace(/ /g,"_").toUpperCase()}`,n=process.env[o];return e&&!n&&x(`Input ${t} is required.`),n||""}function _(){let t=process.env.GITHUB_SHA;if(!t)throw new p("GITHUB_SHA environment variable is not set.");if(!S(t))throw new p("GITHUB_SHA environment variable is invalid.");return b(t)}function I(){let t=process.env.GITHUB_REPOSITORY_OWNER;if(!t)throw new p("GITHUB_REPOSITORY_OWNER environment variable is not set.");return t}function F(){let t=process.env.GITHUB_WORKSPACE;if(!t)throw new p("GITHUB_WORKSPACE environment variable is not set.");return t}import{opendir as et,stat as nt,mkdir as ot}from"fs/promises";import{createReadStream as vt,createWriteStream as rt}from"fs";import k from"path";async function A(t){let e=[];async function o(n){let r=await et(n);for await(let s of r){let i=k.join(n,s.name);s.isDirectory()?await o(i):e.push(i)}}return await o(t),e}async function st(t){try{return(await nt(t)).isDirectory()}catch{return!1}}async function U(t){await st(t)||await ot(t,{recursive:!0})}async function it(t,e){return new Promise((o,n)=>{let r=rt(t);r.write(e),r.end(),r.on("finish",()=>o()),r.on("error",s=>n(s))}).catch(o=>{throw o})}async function at(t,e){return it(t,e)}async function q(t,e){let o=k.join(e,"version.txt");return await at(o,t)}import*as C from"node:https";import{createReadStream as ct}from"fs";import{stat as ut}from"fs/promises";async function H(t,e){let o=await ut(e);return new Promise((n,r)=>{t.headers||(t.headers={}),t.headers["Content-Length"]=o.size;let s=C.request(t,a=>{let c="";a.on("data",u=>{c+=u}),a.on("end",async()=>{a.statusCode&&a.statusCode>=200&&a.statusCode<300?n({statusCode:a.statusCode,body:c}):r(new p(`Request to ${t.hostname} failed with status code: ${a.statusCode}. Response: ${c}`))})});s.on("error",a=>r(a));let i=ct(e);i.pipe(s),i.on("end",()=>s.end()),i.on("error",a=>{s.destroy(),r(a)})}).catch(n=>{throw n})}async function B(t,e){return new Promise((o,n)=>{t.headers||(t.headers={}),t.headers["Content-Length"]=Buffer.byteLength(e);let r=C.request(t,s=>{let i="";s.on("data",a=>{i+=a}),s.on("end",async()=>{s.statusCode&&s.statusCode>=200&&s.statusCode<300?o({statusCode:s.statusCode,body:i}):n(new p(`Request to ${t.hostname} failed with status code: ${s.statusCode}. Response: ${i}`))})});r.on("error",s=>n(s)),r.write(e),r.end()}).catch(o=>{throw o})}var R="1.0",D=`v${R} Decent Tools`;function pt(t){let e="<!-- v",o=t.indexOf(e);if(o===-1)return null;let n=o+e.length,r=t.indexOf(" ",n);return r===-1?null:t.substring(n,r)}function T(t,e){let o=` ${e}='`,n=t.indexOf(o);if(n===-1)return null;let r=n+o.length,s=t.indexOf("'",r);return s===-1?null:t.substring(r,s)}function lt(t){let e=pt(t);if(!e)throw Error("Failed to parse stage index format version.");if(e!==R)throw Error(`Unsupported stage index format version ${e}.`);return e}function G(){return{productionVersion:"",rollbackVersion:"",stageVersion:""}}function N(t,e,o,n){let r=`/_${t}/${e}/`;return`<!DOCTYPE html><html><head><title>Stage Index for ${t}</title><script>
<!-- ${D}. Hand-edit at your own risk! -->
const productionVersion='${o}';
const rollbackVersion='${n}';
const stageVersion='${e}';
window.location.href='${r}';
</script></head><body></body></html>`}async function L(t){let e=`https://decentapps.net/_${t}/index.html`,o=await fetch(e);if(!o.ok)return G();let n=await o.text();try{lt(n)}catch(a){return O(`Could not retrieve app versions from existing stage index at ${e}: ${a.message}.`),G()}let r=T(n,"productionVersion")??"",s=T(n,"rollbackVersion")??"";return{stageVersion:T(n,"stageVersion")??"",productionVersion:r,rollbackVersion:s}}var W="partner.decentapps.net";async function M(t,e,o,n,r,s){let i=s.replace(r,""),a={hostname:W,path:`/api/deployment/${o}/${n}/${i}`,port:443,method:"PUT",headers:{"Content-Type":"application/octet-stream",Authorization:`Bearer ${e}`,"x-repo-owner":t,Accept:"application/json"}},c=await H(a,s);if(c.statusCode<200||c.statusCode>=300)throw new p(`Failed to upload file to partner service. Status code: ${c.statusCode}. Response: ${c.body}`)}async function j(t,e,o,n,r,s,i){let a=i?`/api/deployment/${o}/index.html`:`/api/deployment/${o}/index.html?updateRoute=true`,c={hostname:W,path:a,port:443,method:"PUT",headers:{"Content-Type":"text/html",Authorization:`Bearer ${e}`,"x-repo-owner":t,Accept:"application/json"}},u=N(o,n,r,s),f=await B(c,u);if(f.statusCode<200||f.statusCode>=300)throw new Error(`Failed to upload file to partner service. Status code: ${f.statusCode}. Response: ${f.body}`)}async function dt(){try{g("Collecting inputs needed for deployment");let t=_(),e=I(),o=v("api-key",!0),n=v("app-name",!0);h(),g("Preparing local dist path and version file");let r=`${F()}/dist/`;await U(r),await q(t,r),h(),g("Preparing files for upload");async function s(d){let l=i[d];if(l!=="")try{w(`Uploading ${l}`),await M(e,o,n,t,r,l),y(),i[d]="",++c}catch(X){V(),console.warn(`Failed to upload file ${l}: ${X.message}.`)}}let i=await A(r),a=i.map((d,l)=>()=>s(l));h(),g(`Uploading ${a.length} files`);let c=0,u=3,f=10;for(let d=0;d<u;++d){d>0&&console.warn(`Retrying after failed uploads... (${d+1}/${u})`);try{if(await P(a,f),c===i.length)break}catch(l){l(`Unexpected error while uploading files: ${l.message}.`)}}c<i.length&&(c===0&&x("Failed to upload any files. See previous warnings for details."),x(`Failed to upload all files. Only ${c} of ${i.length} files were uploaded successfully. See previous warnings for details.`)),h(),g("Updating stage index"),w("Fetching app versions");let{productionVersion:z,rollbackVersion:K}=await L(n);y(),w("Uploading new stage index"),await j(e,o,n,t,z,K,!1),y(),h();let Y=`https://decentapps.net/_${n}/${t}/`;E(`Successfully deployed ${c} files to ${Y}.`)}catch(t){let o=`Exception: ${t.stack}`;x(o)}}dt();
