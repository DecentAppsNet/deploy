async function $(t,e){let n=t.length,o=[...t];return new Promise((r,s)=>{function i(c){c().then(()=>{if(--n===0){r();return}if(o&&o.length){let u=o.pop();u&&i(u)}}).catch(u=>s(u))}let a=Math.min(e,t.length);for(let c=0;c<a;++c){let u=o.pop();u&&i(u)}}).catch(r=>{throw r})}function L(t){return/^[0-9a-f]{7}$/i.test(t)}function M(t){return/^[0-9a-f]{40}$/i.test(t)}function C(t){return L(t)||M(t)}function v(t){return t.length>7?t.slice(0,7):t}var h=class extends Error{constructor(e){super(e),this.name="ExpectedError"}},d=h;function j(t){console.error(`::error::${t}`)}function R(t){console.warn(`::warning::${t}`)}function z(t){console.log(`::notice::${t}`)}function S(t){z(`\u2705 ${t}`)}function g(t){j(t),process.exit(1)}function m(t,e=!1){let n=`INPUT_${t.replace(/ /g,"_").toUpperCase()}`,o=process.env[n];return e&&!o&&g(`Input ${t} is required.`),o||""}function P(){let t=process.env.GITHUB_SHA;if(!t)throw new d("GITHUB_SHA environment variable is not set.");if(!C(t))throw new d("GITHUB_SHA environment variable is invalid.");return v(t)}function _(){let t=process.env.GITHUB_REPOSITORY_OWNER;if(!t)throw new d("GITHUB_REPOSITORY_OWNER environment variable is not set.");return t}function T(){let t=process.env.GITHUB_WORKSPACE;if(!t)throw new d("GITHUB_WORKSPACE environment variable is not set.");return t}import{opendir as K,stat as pt,mkdir as lt}from"fs/promises";import{createReadStream as ft,createWriteStream as Y}from"fs";import b from"path";async function E(t){let e=[];async function n(o){let r=await K(o);for await(let s of r){let i=b.join(o,s.name);s.isDirectory()?await n(i):e.push(i)}}return await n(t),e}async function X(t,e){return console.log(`Writing data to local file: ${t}`),new Promise((n,o)=>{console.log("_put:!!1");let r=Y(t);console.log("_put:!!2"),r.write(e),console.log("_put:!!3"),r.end(),console.log("_put:!!4"),r.on("finish",()=>n()),console.log("_put:!!5"),r.on("error",s=>o(s)),console.log("_put:!!6")}).catch(n=>{throw n})}async function J(t,e){return X(t,e)}async function O(t,e){let n=b.join(e,"version.txt");return await J(n,t)}import*as x from"node:https";import{createReadStream as Q}from"fs";import{stat as Z}from"fs/promises";async function V(t,e){let n=await Z(e);return new Promise((o,r)=>{t.headers||(t.headers={}),t.headers["Content-Length"]=n.size;let s=x.request(t,a=>{let c="";a.on("data",u=>{c+=u}),a.on("end",async()=>{a.statusCode&&a.statusCode>=200&&a.statusCode<300?o({statusCode:a.statusCode,body:c}):r(new d(`Request to ${t.hostname} failed with status code: ${a.statusCode}. Response: ${c}`))})});s.on("error",a=>r(a));let i=Q(e);i.pipe(s),i.on("end",()=>s.end()),i.on("error",a=>{s.destroy(),r(a)})}).catch(o=>{throw o})}async function I(t,e){return new Promise((n,o)=>{t.headers||(t.headers={}),t.headers["Content-Length"]=Buffer.byteLength(e);let r=x.request(t,s=>{let i="";s.on("data",a=>{i+=a}),s.on("end",async()=>{s.statusCode&&s.statusCode>=200&&s.statusCode<300?n({statusCode:s.statusCode,body:i}):o(new d(`Request to ${t.hostname} failed with status code: ${s.statusCode}. Response: ${i}`))})});r.on("error",s=>o(s)),r.write(e),r.end()}).catch(n=>{throw n})}var w="1.0",F=`v${w} Decent Tools`;function tt(t){let e="<!-- v",n=t.indexOf(e);if(n===-1)return null;let o=n+e.length,r=t.indexOf(" ",o);return r===-1?null:t.substring(o,r)}function y(t,e){let n=` ${e}='`,o=t.indexOf(n);if(o===-1)return null;let r=o+n.length,s=t.indexOf("'",r);return s===-1?null:t.substring(r,s)}function et(t){let e=tt(t);if(!e)throw Error("Failed to parse stage index format version.");if(e!==w)throw Error(`Unsupported stage index format version ${e}.`);return e}function A(){return{productionVersion:"",rollbackVersion:"",stageVersion:""}}function k(t,e,n,o){let r=`/_${t}/${e}/`;return`<!DOCTYPE html><html><head><title>Stage Index for ${t}</title><script>
<!-- ${F}. Hand-edit at your own risk! -->
const productionVersion='${n}';
const rollbackVersion='${o}';
const stageVersion='${e}';
window.location.href='${r}';
</script></head><body></body></html>`}async function q(t){let e=`https://decentapps.net/_${t}/index.html`,n=await fetch(e);if(!n.ok)return A();let o=await n.text();try{et(o)}catch(a){return R(`Could not retrieve app versions from existing stage index at ${e}: ${a.message}.`),A()}let r=y(o,"productionVersion")??"",s=y(o,"rollbackVersion")??"";return{stageVersion:y(o,"stageVersion")??"",productionVersion:r,rollbackVersion:s}}var U="partner.decentapps.net";async function H(t,e,n,o,r,s){let i=s.replace(r,""),a={hostname:U,path:`/api/deployment/${n}/${o}/${i}`,port:443,method:"PUT",headers:{"Content-Type":"application/octet-stream",Authorization:`Bearer ${e}`,"x-repo-owner":t,Accept:"application/json"}},c=await V(a,s);if(c.statusCode<200||c.statusCode>=300)throw new d(`Failed to upload file to partner service. Status code: ${c.statusCode}. Response: ${c.body}`)}async function B(t,e,n,o,r,s,i){let a=i?`/api/deployment/${n}/index.html`:`/api/deployment/${n}/index.html?updateRoute=true`,c={hostname:U,path:a,port:443,method:"PUT",headers:{"Content-Type":"text/html",Authorization:`Bearer ${e}`,"x-repo-owner":t,Accept:"application/json"}},u=k(n,o,r,s),f=await I(c,u);if(f.statusCode<200||f.statusCode>=300)throw new Error(`Failed to upload file to partner service. Status code: ${f.statusCode}. Response: ${f.body}`)}async function ot(){try{let t=P(),e=_(),n=m("api-key",!0),o=m("app-name",!0),r=`${T()}/dist/`;console.log(`Writing version file to ${r}...`),await O(t,r);async function s(p){let l=i[p];if(l!=="")try{await H(e,n,o,t,r,l),i[p]="",++c}catch(G){console.warn(`Failed to upload file ${l}: ${G.message}.`)}}let i=await E(r);console.log(`Found ${i.length} files to upload:`),i.forEach((p,l)=>{console.log(`  ${l+1}: ${p}`)});let a=i.map((p,l)=>()=>s(l)),c=0,u=3,f=10;for(let p=0;p<u;++p){p>0&&console.warn(`Retrying after failed uploads... (${p+1}/${u})`);try{if(await $(a,f),c===i.length)break}catch(l){l(`Unexpected error while uploading files: ${l.message}.`)}}c<i.length&&(c===0&&g("Failed to upload any files. See previous warnings for details."),g(`Failed to upload all files. Only ${c} of ${i.length} files were uploaded successfully. See previous warnings for details.`));let{productionVersion:D,rollbackVersion:N}=await q(o);await B(e,n,o,t,D,N,!1);let W=`https://decentapps.net/_${o}/${t}/`;S(`Successfully deployed ${c} files to ${W}.`)}catch(t){let n=`Exception: ${t.stack}`;g(n)}}ot();
